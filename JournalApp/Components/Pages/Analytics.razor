@page "/analytics"
@using JournalApp.Services
@using JournalApp.Models
@inject AnalyticsService AnalyticsService
@inject StreakService StreakService
@inject TagService TagService

<div class="analytics-container">
    <div class="header">
        <h1>Analytics Dashboard</h1>
    </div>

    <div class="date-range-selector">
        <label>Start Date:</label>
        <input type="date" @bind="startDate" class="form-control" />
        <label>End Date:</label>
        <input type="date" @bind="endDate" class="form-control" />
        <button class="btn-primary" @onclick="LoadAnalytics">Apply Range</button>
        <button class="btn-secondary" @onclick="ShowAllTime">All Time</button>
    </div>

    <div class="stats-overview">
        <div class="stat-card">
            <h3>Current Streak</h3>
            <div class="stat-value">@currentStreak days</div>
        </div>
        <div class="stat-card">
            <h3>Longest Streak</h3>
            <div class="stat-value">@longestStreak days</div>
        </div>
        <div class="stat-card">
            <h3>Missed Days</h3>
            <div class="stat-value">@missedDaysCount</div>
        </div>
        <div class="stat-card">
            <h3>Average Word Count</h3>
            <div class="stat-value">@((int)averageWordCount)</div>
        </div>
    </div>

    <div class="analytics-grid">
        <div class="chart-card">
            <h3>Mood Distribution</h3>
            <div class="mood-distribution">
                @foreach (var category in moodDistribution)
                {
                    var percentage = totalMoods > 0 ? (category.Value * 100.0 / totalMoods) : 0;
                    <div class="mood-bar">
                        <div class="mood-label">@category.Key</div>
                        <div class="bar-container">
                            <div class="bar @GetMoodCategoryClass(category.Key)"
                                 style="width: @percentage%">
                                @category.Value (@percentage.ToString("F1")%)
                            </div>
                        </div>
                    </div>
                }
            </div>
        </div>

        <div class="chart-card">
            <h3>Most Frequent Moods</h3>
            <div class="mood-frequency">
                @foreach (var mood in moodFrequency.Take(5))
                {
                    var percentage = totalMoods > 0 ? (mood.Value * 100.0 / totalMoods) : 0;
                    var moodObj = Mood.AllMoods.FirstOrDefault(m => m.Name == mood.Key);
                    <div class="mood-item">
                        <span class="mood-icon">@(moodObj?.Icon ?? "ðŸ˜Š")</span>
                        <span class="mood-name">@mood.Key</span>
                        <span class="mood-count">@mood.Value times (@percentage.ToString("F1")%)</span>
                    </div>
                }
            </div>
        </div>

        <div class="chart-card">
            <h3>Most Used Tags</h3>
            <div class="tag-stats">
                @foreach (var tag in mostUsedTags.Take(10))
                {
                    <div class="tag-stat-item">
                        <span class="tag-name">@tag.Key</span>
                        <span class="tag-count">@tag.Value entries</span>
                    </div>
                }
            </div>
        </div>

        <div class="chart-card">
            <h3>Category Breakdown</h3>
            <div class="category-breakdown">
                @if (categoryBreakdown.Any())
                {
                    @foreach (var category in categoryBreakdown)
                    {
                        <div class="category-item">
                            <span class="category-name">@category.Key</span>
                            <span class="category-count">@category.Value entries</span>
                        </div>
                    }
                }
                else
                {
                    <p class="no-data">No category data available</p>
                }
            </div>
        </div>

        <div class="chart-card full-width">
            <h3>Word Count Trends</h3>
            <div class="word-count-trends">
                @if (wordCountTrends.Any())
                {
                    var maxCount = wordCountTrends.Values.Max();
                    @foreach (var trend in wordCountTrends)
                    {
                        var height = maxCount > 0 ? (trend.Value / maxCount * 100) : 0;
                        <div class="trend-bar">
                            <div class="bar" style="height: @height%"></div>
                            <div class="trend-label">@trend.Key</div>
                            <div class="trend-value">@((int)trend.Value)</div>
                        </div>
                    }
                }
                else
                {
                    <p class="no-data">No word count data available</p>
                }
            </div>
        </div>
    </div>
</div>

@code {
    private DateTime? startDate;
    private DateTime? endDate;

    private int currentStreak;
    private int longestStreak;
    private int missedDaysCount;
    private double averageWordCount;

    private Dictionary<MoodCategory, int> moodDistribution = new();
    private Dictionary<string, int> moodFrequency = new();
    private Dictionary<string, int> mostUsedTags = new();
    private Dictionary<string, int> categoryBreakdown = new();
    private Dictionary<string, double> wordCountTrends = new();

    private int totalMoods => moodDistribution.Values.Sum();

    protected override async Task OnInitializedAsync()
    {
        await ShowAllTime();
    }

    private async Task ShowAllTime()
    {
        startDate = null;
        endDate = null;
        await LoadAnalytics();
    }

    private async Task LoadAnalytics()
    {
        var streakData = await StreakService.CalculateStreaksAsync();
        currentStreak = streakData.currentStreak;
        longestStreak = streakData.longestStreak;
        missedDaysCount = streakData.missedDays.Count;

        moodDistribution = await AnalyticsService.GetMoodDistributionAsync(startDate, endDate);
        moodFrequency = await AnalyticsService.GetMoodFrequencyAsync(startDate, endDate);
        mostUsedTags = await TagService.GetTagUsageStatsAsync(startDate, endDate);
        categoryBreakdown = await AnalyticsService.GetCategoryBreakdownAsync(startDate, endDate);
        wordCountTrends = await AnalyticsService.GetWordCountTrendsAsync(startDate, endDate);
        averageWordCount = await AnalyticsService.GetAverageWordCountAsync(startDate, endDate);
    }

    private string GetMoodCategoryClass(MoodCategory category)
    {
        return category switch
        {
            MoodCategory.Positive => "mood-positive",
            MoodCategory.Neutral => "mood-neutral",
            MoodCategory.Negative => "mood-negative",
            _ => ""
        };
    }
}
